<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OS - Project G-Win</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --taskbar-bg: rgba(255, 255, 255, 0.85);
            --window-bg: rgba(255, 255, 255, 0.95);
            --primary: #4285F4;
            --red: #EA4335;
            --yellow: #FBBC05;
            --green: #34A853;
            --text: #202124;
            --shadow: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.10);
            --glass: blur(15px) saturate(120%);
        }

        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #000; color: var(--text); height: 100vh; }

        /* Boot Screen */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 1s;
        }
        .g-logo span { font-size: 4rem; font-weight: bold; display: inline-block; animation: bounce 1.5s infinite ease-in-out; }
        .g-logo span:nth-child(1) { color: var(--primary); animation-delay: 0s; }
        .g-logo span:nth-child(2) { color: var(--red); animation-delay: 0.1s; }
        .g-logo span:nth-child(3) { color: var(--yellow); animation-delay: 0.2s; }
        .g-logo span:nth-child(4) { color: var(--primary); animation-delay: 0.3s; }
        .g-logo span:nth-child(5) { color: var(--green); animation-delay: 0.4s; }
        .g-logo span:nth-child(6) { color: var(--red); animation-delay: 0.5s; }
        .loader { width: 200px; height: 4px; background: #eee; margin-top: 20px; border-radius: 2px; overflow: hidden; }
        .loader-bar { width: 0%; height: 100%; background: var(--primary); transition: width 3s ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Desktop */
        #desktop {
            width: 100%; height: calc(100% - 48px);
            background: url('https://images.unsplash.com/photo-1497294815431-9365093b7331?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80') center/cover no-repeat;
            position: relative; padding: 10px; display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-start; gap: 15px;
        }

        /* Desktop Icons */
        .d-icon {
            width: 72px; height: 85px; display: flex; flex-direction: column; align-items: center;
            color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8); cursor: pointer;
            border-radius: 5px; transition: 0.2s; padding: 5px;
        }
        .d-icon:hover { background: rgba(255,255,255,0.15); }
        .d-icon svg { width: 40px; height: 40px; margin-bottom: 5px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .d-icon span { font-size: 12px; text-align: center; line-height: 1.2; }

        /* Taskbar */
        #taskbar {
            position: fixed; bottom: 0; width: 100%; height: 48px;
            background: var(--taskbar-bg); backdrop-filter: var(--glass);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 9000;
            border-top: 1px solid rgba(255,255,255,0.5);
        }
        .tb-left { display: flex; align-items: center; gap: 10px; }
        .tb-center { display: flex; align-items: center; gap: 8px; position: absolute; left: 50%; transform: translateX(-50%); }
        .tb-right { display: flex; align-items: center; gap: 15px; font-size: 12px; }
        
        .start-btn {
            width: 36px; height: 36px; border-radius: 50%; background: #fff;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .start-btn:hover { background: #f1f1f1; transform: scale(1.05); }
        .start-btn svg { width: 20px; }

        .task-icon {
            width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .task-icon:hover { background: rgba(0,0,0,0.05); }
        .task-icon.active { background: rgba(0,0,0,0.1); }
        .task-icon.active::after { content:''; position: absolute; bottom: 2px; width: 12px; height: 3px; background: var(--primary); border-radius: 2px; }
        .task-icon svg { width: 22px; height: 22px; }

        /* Start Menu */
        #start-menu {
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%) translateY(20px);
            width: 600px; height: 500px; background: rgba(255,255,255,0.9); backdrop-filter: var(--glass);
            border-radius: 12px; box-shadow: var(--shadow); z-index: 9001;
            display: none; opacity: 0; transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 25px; flex-direction: column;
        }
        #start-menu.open { display: flex; opacity: 1; transform: translateX(-50%) translateY(0); }
        .search-bar {
            width: 100%; height: 40px; background: #f1f3f4; border-radius: 20px; border: none;
            padding: 0 20px; font-size: 14px; margin-bottom: 20px; outline: none;
        }
        .app-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 20px; }
        .app-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; gap: 8px; }
        .app-item:hover svg { transform: translateY(-3px); transition: 0.2s; }
        .app-item svg { width: 32px; height: 32px; }
        .app-item span { font-size: 11px; color: #444; }

        /* Window System */
        .window {
            position: absolute; background: var(--window-bg); backdrop-filter: blur(20px);
            border-radius: 8px; box-shadow: var(--shadow); display: flex; flex-direction: column;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.6); min-width: 300px; min-height: 200px;
            animation: popIn 0.2s cubic-bezier(0.1, 0.9, 0.2, 1); resize: both;
        }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .win-header {
            height: 32px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; background: rgba(240,240,240,0.5); cursor: default;
        }
        .win-title { font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .win-controls { display: flex; gap: 8px; }
        .win-btn { width: 10px; height: 10px; border-radius: 50%; cursor: pointer; }
        .close-btn { background: #ff5f57; }
        .min-btn { background: #ffbd2e; }
        .max-btn { background: #28c940; }

        .win-content { flex: 1; overflow: auto; position: relative; background: rgba(255,255,255,0.8); }

        /* App Specific Styles */
        /* Terminal */
        .terminal { background: #1e1e1e; color: #dcdcdc; font-family: 'Consolas', monospace; padding: 10px; height: 100%; font-size: 14px; }
        .term-output { white-space: pre-wrap; }
        .term-input-line { display: flex; }
        .term-prompt { color: #34A853; margin-right: 5px; }
        .term-input { background: transparent; border: none; color: inherit; outline: none; flex: 1; font-family: inherit; }

        /* Code Editor */
        .code-editor { display: flex; height: 100%; flex-direction: column; }
        .code-area { flex: 1; background: #282c34; color: #abb2bf; border: none; resize: none; padding: 10px; font-family: 'Consolas', monospace; outline: none; }
        .code-status { height: 24px; background: #21252b; color: #9da5b4; font-size: 11px; display: flex; align-items: center; padding: 0 10px; }

        /* Notepad */
        .notepad-area { width: 100%; height: 100%; border: none; resize: none; padding: 10px; font-family: sans-serif; outline: none; background: rgba(255,255,255,0.5); }

        /* Paint */
        .paint-toolbar { height: 40px; border-bottom: 1px solid #ccc; display: flex; align-items: center; padding: 0 10px; gap: 10px; background: #f9f9f9; }
        canvas { cursor: crosshair; background: #fff; display: block; }

        /* File Explorer */
        .explorer { display: flex; height: 100%; }
        .sidebar { width: 150px; background: rgba(0,0,0,0.03); padding: 10px; border-right: 1px solid rgba(0,0,0,0.1); }
        .file-view { flex: 1; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); align-content: flex-start; gap: 10px; }
        .file-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 5px; border-radius: 4px; }
        .file-item:hover { background: rgba(66, 133, 244, 0.1); }
        .file-icon { width: 40px; height: 40px; margin-bottom: 5px; }
        .file-name { font-size: 12px; text-align: center; word-break: break-all; }

        /* Snake Game */
        .snake-canvas { background: #000; margin: 0 auto; display: block; }
        .score-board { text-align: center; padding: 5px; font-weight: bold; }

        /* Video Editor */
        .video-ui { display: flex; flex-direction: column; height: 100%; }
        .video-preview { flex: 2; background: #000; display: flex; align-items: center; justify-content: center; color: #666; }
        .video-timeline { flex: 1; background: #333; padding: 10px; overflow-x: auto; white-space: nowrap; }
        .clip { display: inline-block; height: 60px; width: 100px; background: var(--primary); margin-right: 2px; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; position: relative; }
        .clip::after { content: 'Clip'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 10px; }

        /* Utils */
        .context-menu {
            position: absolute; background: rgba(255,255,255,0.95); border: 1px solid #ccc;
            border-radius: 5px; padding: 5px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none; z-index: 99999; width: 150px;
        }
        .ctx-item { padding: 8px 15px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; }
        .ctx-item:hover { background: var(--primary); color: white; }

    </style>
</head>
<body>

    <!-- Boot Screen -->
    <div id="boot-screen">
        <div class="g-logo">
            <span>G</span><span>o</span><span>o</span><span>g</span><span>l</span><span>e</span>
        </div>
        <div class="loader">
            <div class="loader-bar" id="boot-progress"></div>
        </div>
    </div>

    <!-- Desktop -->
    <div id="desktop">
        <!-- Icons generated by JS -->
    </div>

    <!-- Taskbar -->
    <div id="taskbar">
        <div class="tb-left">
            <div class="start-btn" onclick="toggleStartMenu()">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M3 3h8v8H3z" fill="#F25022"/>
                    <path d="M13 3h8v8h-8z" fill="#7FBA00"/>
                    <path d="M3 13h8v8H3z" fill="#00A4EF"/>
                    <path d="M13 13h8v8h-8z" fill="#FFB900"/>
                </svg>
            </div>
            <div class="search-btn" style="margin-left:10px; color:#666;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>
        </div>
        <div class="tb-center" id="taskbar-apps">
            <!-- Active Apps generated by JS -->
        </div>
        <div class="tb-right">
            <div id="sys-tray-wifi">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C7.95 2 4.21 3.34 1.2 5.5L12 21.5L22.8 5.5C19.79 3.34 16.05 2 12 2Z"/></svg>
            </div>
            <div id="sys-tray-vol">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            </div>
            <div id="clock" style="margin-left:10px; text-align:right;">
                <div id="time-text" style="font-weight:500;">12:00</div>
                <div id="date-text" style="font-size:10px; color:#666;">2023/11/20</div>
            </div>
            <div style="width:2px; height:30px; background:rgba(0,0,0,0.1); margin-left:5px;"></div>
        </div>
    </div>

    <!-- Start Menu -->
    <div id="start-menu">
        <input type="text" class="search-bar" placeholder="搜索应用、文件和网络...">
        <div style="padding-bottom: 10px; font-size: 12px; font-weight: bold; color: #555;">已固定</div>
        <div class="app-grid" id="start-grid">
            <!-- Icons generated by JS -->
        </div>
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 32px; height: 32px; background: #ccc; border-radius: 50%; overflow:hidden;"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=GoogleUser" width="32"></div>
                <div style="font-size: 12px; font-weight: 500;">User</div>
            </div>
            <div onclick="alert('模拟关机...')" style="cursor: pointer; padding: 5px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="ctx-menu" class="context-menu">
        <div class="ctx-item" onclick="wm.refresh()"><span>刷新</span></div>
        <div class="ctx-item" onclick="alert('已整理')"><span>排序方式</span><span>></span></div>
        <div style="height:1px; background:#eee; margin:2px 0;"></div>
        <div class="ctx-item" onclick="wm.openApp('settings')"><span>显示设置</span></div>
        <div class="ctx-item" onclick="wm.openApp('terminal')"><span>在终端中打开</span></div>
    </div>

    <script>
        // --- SVG Icons (Minimal Set) ---
        const ICONS = {
            terminal: `<svg viewBox="0 0 24 24" fill="#333"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM7.5 17l-1.41-1.41L9.67 12 6.09 8.41 7.5 7l5 5-5 5zm5.5-1h5v2h-5z"/></svg>`,
            code: `<svg viewBox="0 0 24 24" fill="#2196F3"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>`,
            folder: `<svg viewBox="0 0 24 24" fill="#FBBC05"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>`,
            chrome: `<svg viewBox="0 0 24 24"><path fill="#EA4335" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>`,
            game: `<svg viewBox="0 0 24 24" fill="#9C27B0"><path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>`,
            paint: `<svg viewBox="0 0 24 24" fill="#E91E63"><path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34c-.39-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.02 0-1.41z"/></svg>`,
            video: `<svg viewBox="0 0 24 24" fill="#F44336"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>`,
            notepad: `<svg viewBox="0 0 24 24" fill="#607D8B"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>`,
            settings: `<svg viewBox="0 0 24 24" fill="#5f6368"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L5.09 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>`
        };

        // --- Application Definitions ---
        const APPS = {
            "computer": { name: "此电脑", icon: ICONS.folder, type: "app", action: "explorer" },
            "chrome": { name: "Chrome", icon: ICONS.chrome, type: "app", action: "chrome" },
            "terminal": { name: "终端 (Python)", icon: ICONS.terminal, type: "app", action: "terminal" },
            "code": { name: "VS Code", icon: ICONS.code, type: "app", action: "code" },
            "paint": { name: "画图", icon: ICONS.paint, type: "app", action: "paint" },
            "game": { name: "贪吃蛇", icon: ICONS.game, type: "app", action: "snake" },
            "video": { name: "视频编辑器", icon: ICONS.video, type: "app", action: "video" },
            "notepad": { name: "记事本", icon: ICONS.notepad, type: "app", action: "notepad" },
            "settings": { name: "设置", icon: ICONS.settings, type: "app", action: "settings" }
        };

        // --- Virtual File System ---
        const FS = {
            "Desktop": ["Project.py", "Notes.txt", "Image.png"],
            "Documents": ["Resume.docx", "Budget.xlsx"],
            "Downloads": ["installer.exe"],
            "Pictures": ["Holiday.jpg"],
            "Videos": []
        };

        // --- Audio System ---
        const AudioSys = {
            ctx: null,
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playBootSound: function() {
                this.init();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                // Google Chord: G, B, D, F# (Gmaj7ish)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(196.00, t); // G3
                osc.frequency.exponentialRampToValueAtTime(392.00, t + 0.5); // G4
                
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.3, t + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 3);

                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(t);
                osc.stop(t + 3);

                // Add a higher harmony
                const osc2 = this.ctx.createOscillator();
                const gain2 = this.ctx.createGain();
                osc2.type = 'triangle';
                osc2.frequency.setValueAtTime(329.63, t); // E4
                gain2.gain.setValueAtTime(0, t);
                gain2.gain.linearRampToValueAtTime(0.1, t+0.2);
                gain2.gain.exponentialRampToValueAtTime(0.001, t+3);
                osc2.connect(gain2);
                gain2.connect(this.ctx.destination);
                osc2.start(t);
                osc2.stop(t+3);
            }
        };

        // --- Window Manager ---
        class WindowManager {
            constructor() {
                this.desktop = document.getElementById('desktop');
                this.taskbarApps = document.getElementById('taskbar-apps');
                this.windows = [];
                this.zIndex = 100;
                this.activeWindow = null;
            }

            createWindow(appKey, contentHtml = "", width = 600, height = 400) {
                const app = APPS[appKey];
                const winId = 'win-' + Date.now();
                
                const win = document.createElement('div');
                win.className = 'window';
                win.id = winId;
                win.style.width = width + 'px';
                win.style.height = height + 'px';
                win.style.left = (100 + (this.windows.length * 30)) + 'px';
                win.style.top = (50 + (this.windows.length * 30)) + 'px';
                win.style.zIndex = ++this.zIndex;

                win.innerHTML = `
                    <div class="win-header" onmousedown="wm.startDrag(event, '${winId}')">
                        <div class="win-title">${app.icon} ${app.name}</div>
                        <div class="win-controls">
                            <div class="win-btn min-btn" onclick="wm.minimize('${winId}')"></div>
                            <div class="win-btn max-btn" onclick="wm.maximize('${winId}')"></div>
                            <div class="win-btn close-btn" onclick="wm.close('${winId}')"></div>
                        </div>
                    </div>
                    <div class="win-content">${contentHtml}</div>
                `;

                win.onmousedown = () => this.focus(winId);
                this.desktop.appendChild(win);
                this.windows.push({ id: winId, appKey: appKey, el: win });
                this.addToTaskbar(winId, app);
                this.focus(winId);
                return win.querySelector('.win-content'); // Return content area for app logic
            }

            addToTaskbar(winId, app) {
                const icon = document.createElement('div');
                icon.className = 'task-icon active';
                icon.id = 'tb-' + winId;
                icon.innerHTML = app.icon;
                icon.onclick = () => this.toggleMinMax(winId);
                this.taskbarApps.appendChild(icon);
            }

            close(winId) {
                const win = document.getElementById(winId);
                win.remove();
                document.getElementById('tb-' + winId).remove();
                this.windows = this.windows.filter(w => w.id !== winId);
            }

            focus(winId) {
                const win = document.getElementById(winId);
                if(win) {
                    win.style.zIndex = ++this.zIndex;
                    this.activeWindow = winId;
                    // Update taskbar active state
                    document.querySelectorAll('.task-icon').forEach(el => el.classList.remove('active'));
                    const tb = document.getElementById('tb-' + winId);
                    if(tb) tb.classList.add('active');
                }
            }

            minimize(winId) {
                const win = document.getElementById(winId);
                win.style.display = 'none';
                document.getElementById('tb-' + winId).classList.remove('active');
            }

            toggleMinMax(winId) {
                const win = document.getElementById(winId);
                if (win.style.display === 'none') {
                    win.style.display = 'flex';
                    this.focus(winId);
                } else {
                    if (this.activeWindow === winId) this.minimize(winId);
                    else this.focus(winId);
                }
            }

            maximize(winId) {
                const win = document.getElementById(winId);
                if(win.style.width === '100%') {
                    win.style.width = '600px'; win.style.height = '400px'; win.style.top = '50px'; win.style.left = '100px';
                } else {
                    win.style.width = '100%'; win.style.height = '100%'; win.style.top = '0'; win.style.left = '0';
                }
            }

            startDrag(e, winId) {
                if(e.target.classList.contains('win-btn')) return; // Don't drag if clicking buttons
                const win = document.getElementById(winId);
                let shiftX = e.clientX - win.getBoundingClientRect().left;
                let shiftY = e.clientY - win.getBoundingClientRect().top;

                function moveAt(pageX, pageY) {
                    win.style.left = pageX - shiftX + 'px';
                    win.style.top = pageY - shiftY + 'px';
                }

                function onMouseMove(event) { moveAt(event.pageX, event.pageY); }

                document.addEventListener('mousemove', onMouseMove);
                document.onmouseup = function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.onmouseup = null;
                };
            }

            openApp(appKey) {
                document.getElementById('start-menu').classList.remove('open'); // Close start menu
                const app = APPS[appKey];
                let content = "";
                let container;

                switch(app.action) {
                    case 'terminal':
                        container = this.createWindow(appKey, '<div class="terminal"><div class="term-output">Google OS v1.0.0 [Python Emulation]\nType "help", "date", "python" or math.\n\n</div><div class="term-input-line"><span class="term-prompt">$</span><input type="text" class="term-input" autofocus></div></div>', 600, 400);
                        initTerminal(container);
                        break;
                    case 'code':
                        container = this.createWindow(appKey, '<div class="code-editor"><div class="code-status">main.py - Google Code</div><textarea class="code-area" spellcheck="false">def hello():\n    print("Hello Google OS")\n\nhello()</textarea><div class="code-status">Ln 4, Col 1</div></div>', 700, 500);
                        break;
                    case 'paint':
                        container = this.createWindow(appKey, '<div class="paint-toolbar"><input type="color" id="p-color" value="#000000"><input type="range" id="p-size" min="1" max="20" value="5"><button onclick="paintClear()">清空</button></div><div style="flex:1; overflow:hidden;"><canvas id="paint-canvas"></canvas></div>', 600, 450);
                        initPaint(container);
                        break;
                    case 'snake':
                        container = this.createWindow(appKey, '<div class="score-board">Score: <span id="score">0</span></div><canvas id="snake-game" width="400" height="400" class="snake-canvas"></canvas>', 420, 460);
                        initSnake(container);
                        break;
                    case 'chrome':
                        container = this.createWindow(appKey, '<div style="padding:10px; text-align:center; height:100%; display:flex; flex-direction:column; justify-content:center;"><h1>Google</h1><input type="text" style="width:80%; padding:10px; border-radius:20px; border:1px solid #ccc; outline:none;" placeholder="在 Google 上搜索..."></div>', 800, 500);
                        break;
                    case 'explorer':
                        let fileHtml = '';
                        for(let f in FS) fileHtml += `<div class="file-item"><div class="file-icon">${ICONS.folder}</div><div class="file-name">${f}</div></div>`;
                        container = this.createWindow(appKey, `<div class="explorer"><div class="sidebar"><div>快速访问</div><div style="margin-top:10px; padding-left:10px; font-size:12px;">桌面<br>下载<br>文档</div></div><div class="file-view">${fileHtml}</div></div>`, 600, 400);
                        break;
                    case 'video':
                        container = this.createWindow(appKey, `<div class="video-ui"><div class="video-preview"><svg width="50" height="50" viewBox="0 0 24 24" fill="#333"><path d="M8 5v14l11-7z"/></svg></div><div class="video-timeline"><div class="clip" style="width:80px; background:#EA4335">Intro</div><div class="clip" style="width:150px; background:#4285F4">Main Content</div><div class="clip" style="width:60px; background:#34A853">Outro</div></div></div>`, 700, 450);
                        break;
                    case 'notepad':
                        container = this.createWindow(appKey, `<textarea class="notepad-area">欢迎使用 Google OS。\n\n这是一个基于 Web 技术构建的操作系统概念演示。</textarea>`, 500, 300);
                        break;
                    case 'settings':
                        container = this.createWindow(appKey, `<div style="padding:20px;"><h3>设置</h3><hr><p>系统版本: G-Win 1.0</p><p>内核: JavaScript V8</p><button onclick="document.body.requestFullscreen()">全屏模式</button></div>`, 400, 300);
                        break;
                }
            }
        }

        const wm = new WindowManager();

        // --- Logic: System Boot ---
        window.onload = () => {
            const bar = document.getElementById('boot-progress');
            bar.style.width = "100%";
            setTimeout(() => {
                const screen = document.getElementById('boot-screen');
                screen.style.opacity = 0;
                setTimeout(() => { 
                    screen.remove(); 
                    // Try to play sound on user interaction if blocked
                    document.body.addEventListener('click', () => AudioSys.playBootSound(), {once:true});
                }, 1000);
            }, 3000);

            setupDesktop();
            updateClock();
            setInterval(updateClock, 1000);
            
            // Right Click Menu
            document.addEventListener('contextmenu', e => {
                e.preventDefault();
                const menu = document.getElementById('ctx-menu');
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
            });
            document.addEventListener('click', () => document.getElementById('ctx-menu').style.display = 'none');
        };

        function setupDesktop() {
            const desk = document.getElementById('desktop');
            const startGrid = document.getElementById('start-grid');
            
            Object.keys(APPS).forEach(key => {
                const app = APPS[key];
                
                // Desktop Icon
                if(key !== 'settings') {
                    const el = document.createElement('div');
                    el.className = 'd-icon';
                    el.innerHTML = `${app.icon}<span>${app.name}</span>`;
                    el.ondblclick = () => wm.openApp(key);
                    desk.appendChild(el);
                }

                // Start Menu Icon
                const sEl = document.createElement('div');
                sEl.className = 'app-item';
                sEl.innerHTML = `${app.icon}<span>${app.name}</span>`;
                sEl.onclick = () => wm.openApp(key);
                startGrid.appendChild(sEl);
            });
        }

        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            menu.classList.toggle('open');
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('time-text').innerText = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
            document.getElementById('date-text').innerText = now.getFullYear() + '/' + (now.getMonth()+1) + '/' + now.getDate();
        }

        // --- App Logic Implementations ---

        // 1. Terminal (Fake Python)
        function initTerminal(container) {
            const input = container.querySelector('.term-input');
            const output = container.querySelector('.term-output');
            const prompt = container.querySelector('.term-prompt');
            let isPython = false;

            input.addEventListener('keydown', function(e) {
                if(e.key === 'Enter') {
                    const val = this.value;
                    output.innerText += (isPython ? '>>> ' : '$ ') + val + '\n';
                    
                    if(isPython) {
                        if(val === 'exit()') { isPython = false; prompt.innerText = '$'; prompt.style.color='#34A853'; }
                        else if(val.startsWith('print(')) {
                            try { output.innerText += val.substring(6, val.length-1).replace(/["']/g, '') + '\n'; } catch(e){ output.innerText += "Error\n";}
                        }
                        else {
                            try { output.innerText += eval(val) + '\n'; } catch(e) { output.innerText += "Traceback (most recent call last): Error\n"; }
                        }
                    } else {
                        if(val === 'python') { isPython = true; prompt.innerText = '>>>'; prompt.style.color='#FFD700'; output.innerText += "Python 3.10.0 (default, Nov 20 2023) [GCC]\nType \"help\", \"copyright\" for more information.\n"; }
                        else if(val === 'help') output.innerText += "Commands: python, date, clear, ls, whoami\n";
                        else if(val === 'clear') output.innerText = "";
                        else if(val === 'date') output.innerText += new Date().toString() + '\n';
                        else if(val === 'ls') output.innerText += "Desktop  Documents  Downloads  Pictures\n";
                        else if(val.trim() !== "") output.innerText += `command not found: ${val}\n`;
                    }
                    
                    this.value = '';
                    container.scrollTop = container.scrollHeight;
                }
            });
        }

        // 2. Paint
        function initPaint(container) {
            const canvas = container.querySelector('#paint-canvas');
            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            
            let painting = false;
            const colorInp = container.querySelector('#p-color');
            const sizeInp = container.querySelector('#p-size');

            function startPosition(e) { painting = true; draw(e); }
            function finishedPosition() { painting = false; ctx.beginPath(); }
            function draw(e) {
                if(!painting) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineWidth = sizeInp.value;
                ctx.lineCap = 'round';
                ctx.strokeStyle = colorInp.value;
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }

            canvas.addEventListener('mousedown', startPosition);
            canvas.addEventListener('mouseup', finishedPosition);
            canvas.addEventListener('mousemove', draw);
            window.paintClear = () => ctx.clearRect(0,0, canvas.width, canvas.height);
        }

        // 3. Snake Game
        function initSnake(container) {
            const cvs = container.querySelector('#snake-game');
            const ctx = cvs.getContext('2d');
            const scoreEl = container.querySelector('#score');
            
            const box = 20;
            let snake = [];
            snake[0] = { x: 9 * box, y: 10 * box };
            let food = { x: Math.floor(Math.random()*19+1) * box, y: Math.floor(Math.random()*19+1) * box };
            let score = 0;
            let d;
            let game;

            document.addEventListener("keydown", direction);
            function direction(event) {
                if(event.keyCode == 37 && d != "RIGHT") d = "LEFT";
                else if(event.keyCode == 38 && d != "DOWN") d = "UP";
                else if(event.keyCode == 39 && d != "LEFT") d = "RIGHT";
                else if(event.keyCode == 40 && d != "UP") d = "DOWN";
            }

            function draw() {
                ctx.fillStyle = "#111";
                ctx.fillRect(0, 0, 400, 400);

                for(let i = 0; i < snake.length; i++) {
                    ctx.fillStyle = (i == 0) ? "#4285F4" : "white";
                    ctx.fillRect(snake[i].x, snake[i].y, box, box);
                    ctx.strokeStyle = "black";
                    ctx.strokeRect(snake[i].x, snake[i].y, box, box);
                }

                ctx.fillStyle = "#EA4335";
                ctx.fillRect(food.x, food.y, box, box);

                let snakeX = snake[0].x;
                let snakeY = snake[0].y;

                if(d == "LEFT") snakeX -= box;
                if(d == "UP") snakeY -= box;
                if(d == "RIGHT") snakeX += box;
                if(d == "DOWN") snakeY += box;

                if(snakeX == food.x && snakeY == food.y) {
                    score++;
                    scoreEl.innerText = score;
                    food = { x: Math.floor(Math.random()*19+1) * box, y: Math.floor(Math.random()*19+1) * box };
                } else {
                    snake.pop();
                }

                if(snakeX < 0 || snakeX > 19 * box || snakeY < 0 || snakeY > 19 * box || collision( {x:snakeX, y:snakeY}, snake)) {
                    clearInterval(game);
                    alert("Game Over! Score: " + score);
                }

                let newHead = { x: snakeX, y: snakeY };
                snake.unshift(newHead);
            }

            function collision(head, array) {
                for(let i = 0; i < array.length; i++) {
                    if(head.x == array[i].x && head.y == array[i].y) return true;
                }
                return false;
            }
            
            // Stop previous game interval if exists attached to window (hacky but works for single file)
            if(window.snakeInterval) clearInterval(window.snakeInterval);
            game = setInterval(draw, 100);
            window.snakeInterval = game;
        }

    </script>
</body>
</html>