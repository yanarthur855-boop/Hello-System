<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebOS 2025 - Ultimate Edition</title>
<style>
    :root {
        --bg-color: #1e1e1e;
        --taskbar-color: rgba(32, 32, 32, 0.95);
        --win-bg: #252526;
        --win-header: #333333;
        --accent: #0078d7;
        --text-main: #ffffff;
        --text-dim: #cccccc;
        --border: 1px solid #454545;
    }

    * { box-sizing: border-box; user-select: none; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #000; color: var(--text-main); }

    /* --- Boot Screen --- */
    #boot-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999; display: flex; flex-direction: column;
        align-items: center; justify-content: center; transition: opacity 1s;
    }
    .logo-spin {
        width: 80px; height: 80px; border: 5px solid transparent;
        border-top: 5px solid var(--accent); border-right: 5px solid var(--accent);
        border-radius: 50%; animation: spin 1.5s linear infinite; margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .boot-text { font-size: 1.2rem; letter-spacing: 2px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

    /* --- Desktop --- */
    #desktop {
        width: 100%; height: calc(100% - 45px); position: relative;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        background-size: cover;
        overflow: hidden;
    }

    /* --- Icons --- */
    .desktop-icon {
        width: 80px; height: 90px; display: flex; flex-direction: column;
        align-items: center; justify-content: flex-start; padding: 10px;
        cursor: pointer; color: white; text-shadow: 1px 1px 2px black;
        border: 1px solid transparent; border-radius: 4px; margin: 5px;
        float: left;
    }
    .desktop-icon:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
    .icon-img { width: 40px; height: 40px; margin-bottom: 5px; }

    /* --- Windows --- */
    .window {
        position: absolute; background: var(--win-bg); border: var(--border);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 6px;
        display: flex; flex-direction: column; overflow: hidden;
        min-width: 300px; min-height: 200px;
        animation: popIn 0.2s ease-out;
    }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .win-header {
        height: 32px; background: var(--win-header); display: flex;
        align-items: center; justify-content: space-between; padding: 0 10px;
        cursor: default;
    }
    .win-title { font-size: 13px; display: flex; align-items: center; gap: 8px; }
    .win-controls { display: flex; gap: 10px; }
    .win-btn { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; position: relative; }
    .btn-close { background: #ff5f56; }
    .btn-min { background: #ffbd2e; }
    .btn-max { background: #27c93f; }
    .btn-close:hover::after { content: '√ó'; position: absolute; top:-2px; left:3px; color:rgba(0,0,0,0.5); font-size:10px; }
    
    .win-body { flex: 1; overflow: auto; position: relative; background: #1e1e1e; }

    /* --- Taskbar --- */
    #taskbar {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 45px;
        background: var(--taskbar-color); backdrop-filter: blur(10px);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 10px; z-index: 9000; border-top: 1px solid rgba(255,255,255,0.1);
    }
    #start-btn {
        width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: 0.2s; border-radius: 4px;
    }
    #start-btn:hover { background: rgba(255,255,255,0.1); }
    .task-items { display: flex; flex: 1; margin-left: 10px; height: 100%; align-items: center; gap: 4px; }
    .task-item {
        height: 38px; width: 40px; display: flex; align-items: center; justify-content: center;
        border-radius: 4px; cursor: pointer; position: relative;
    }
    .task-item:hover { background: rgba(255,255,255,0.1); }
    .task-item.active { background: rgba(255,255,255,0.15); border-bottom: 2px solid var(--accent); }
    .task-item img { width: 24px; height: 24px; }
    
    #clock-tray { font-size: 12px; text-align: right; display: flex; flex-direction: column; justify-content: center; padding: 0 10px; cursor: default; }
    
    /* --- Start Menu --- */
    #start-menu {
        position: absolute; bottom: 50px; left: 10px; width: 320px; height: 450px;
        background: rgba(37, 37, 38, 0.98); backdrop-filter: blur(15px);
        border: var(--border); border-radius: 6px; display: none;
        flex-direction: column; z-index: 9001; padding: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        animation: slideUp 0.2s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .start-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; }
    .start-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; font-size: 12px; text-align: center; }
    .start-item:hover { opacity: 0.8; }
    .start-item img { width: 32px; height: 32px; margin-bottom: 5px; }

    /* --- App Specific Styles --- */
    /* Terminal */
    .terminal { background: #0c0c0c; color: #cccccc; padding: 10px; font-family: 'Consolas', monospace; height: 100%; font-size: 14px; }
    .term-output { white-space: pre-wrap; }
    .term-input-line { display: flex; color: #fff; }
    .term-prompt { color: #0f0; margin-right: 8px; }
    .term-input { background: transparent; border: none; color: #fff; flex: 1; outline: none; font-family: inherit; font-size: inherit; }
    
    /* Notepad */
    textarea.notepad-area { width: 100%; height: 100%; background: #1e1e1e; color: #fff; border: none; outline: none; resize: none; padding: 10px; font-family: 'Consolas', monospace; }

    /* Paint */
    .paint-toolbar { height: 40px; background: #333; display: flex; align-items: center; gap: 10px; padding: 0 10px; border-bottom: 1px solid #444; }
    .paint-canvas-container { width: 100%; height: calc(100% - 40px); background: #808080; overflow: auto; display: flex; justify-content: center; align-items: center; }
    canvas { background: #fff; cursor: crosshair; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); }

    /* File Explorer */
    .explorer-layout { display: flex; height: 100%; }
    .sidebar { width: 150px; background: #252526; border-right: 1px solid #333; padding: 10px; font-size: 13px; }
    .main-files { flex: 1; background: #1e1e1e; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; align-content: start; }
    .file-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #fff; padding: 5px; border-radius: 4px; }
    .file-item:hover { background: rgba(255,255,255,0.1); }
    .file-icon { width: 40px; height: 40px; margin-bottom: 5px; }
    .file-name { font-size: 12px; text-align: center; word-break: break-all; }

    /* Code Editor */
    .code-layout { display: flex; height: 100%; flex-direction: column; }
    .code-area { flex: 1; display: flex; background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', monospace; font-size: 14px; }
    .line-numbers { width: 40px; background: #1e1e1e; color: #858585; text-align: right; padding: 10px 5px; border-right: 1px solid #333; line-height: 1.5; }
    .code-input { flex: 1; background: transparent; border: none; color: inherit; outline: none; resize: none; padding: 10px; line-height: 1.5; white-space: pre; overflow: auto; }

    /* Snake Game */
    .game-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #222; color: #0f0; font-family: monospace; }
    .game-score { font-size: 20px; margin-bottom: 10px; }
    #snake-canvas { border: 2px solid #444; background: #000; }

    /* Video Timeline Mock */
    .video-app { display: flex; flex-direction: column; height: 100%; background: #222; }
    .preview-area { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #444; position: relative; }
    .timeline-area { height: 150px; background: #2d2d2d; padding: 10px; overflow-x: auto; white-space: nowrap; }
    .track { height: 40px; background: #333; margin-bottom: 5px; position: relative; width: 1000px; border-radius: 4px; }
    .clip { position: absolute; height: 100%; background: #0078d7; border-radius: 4px; opacity: 0.8; border: 1px solid #fff; cursor: move; display: flex; align-items: center; justify-content: center; font-size: 10px; overflow: hidden;}
    .play-btn { padding: 5px 15px; background: var(--accent); border: none; color: white; cursor: pointer; margin: 5px; }
    .moving-box { width: 50px; height: 50px; background: red; position: absolute; }

    /* BSOD */
    #bsod { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0078d7; z-index: 10000; color: white; padding: 100px; font-family: 'Segoe UI', sans-serif; font-size: 20px; }
    .sad-face { font-size: 100px; margin-bottom: 40px; }

    /* SVG Icons Data */
    .svg-icon { width: 100%; height: 100%; fill: currentColor; }
</style>
</head>
<body>

<!-- Boot Screen -->
<div id="boot-screen" onclick="startSystem()">
    <div class="logo-spin"></div>
    <div class="boot-text">SYSTEM INITIALIZING...</div>
    <div style="margin-top:20px; font-size:12px; color:#666;">ÁÇπÂáª‰ªªÊÑèÂ§ÑÂêØÂä®Á≥ªÁªü / Click anywhere to boot</div>
</div>

<!-- BSOD -->
<div id="bsod">
    <div class="sad-face">:(</div>
    <p>‰Ω†ÁöÑËÆæÂ§áÈÅáÂà∞ÈóÆÈ¢òÔºåÈúÄË¶ÅÈáçÂêØ„ÄÇ</p>
    <p>Êàë‰ª¨Âè™Êî∂ÈõÜÊüê‰∫õÈîôËØØ‰ø°ÊÅØÔºåÁÑ∂Âêé‰∏∫‰Ω†ÈáçÊñ∞ÂêØÂä®„ÄÇ</p>
    <br>
    <p>ÂÅúÊ≠¢‰ª£Á†Å: CRITICAL_PROCESS_DIED</p>
    <br>
    <p><i>Âà∑Êñ∞È°µÈù¢‰ª•ÊÅ¢Â§ç„ÄÇ</i></p>
</div>

<!-- Desktop Environment -->
<div id="desktop">
    <!-- Desktop Icons will be injected here -->
</div>

<!-- Start Menu -->
<div id="start-menu">
    <div style="padding-bottom: 10px; border-bottom: 1px solid #444; font-weight: bold;">ÂºÄÂßã</div>
    <div class="start-grid" id="start-apps">
        <!-- App shortcuts injected here -->
    </div>
    <div style="margin-top: auto; padding-top: 10px; border-top: 1px solid #444; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 30px; height: 30px; background: #ccc; border-radius: 50%; display: flex; justify-content: center; align-items: center; color:#000; font-weight:bold;">A</div>
            <span>Admin</span>
        </div>
        <div style="cursor: pointer;" onclick="location.reload()">‚èª</div>
    </div>
</div>

<!-- Taskbar -->
<div id="taskbar">
    <div id="start-btn" onclick="toggleStartMenu()">
        <svg viewBox="0 0 24 24" fill="white" style="width:20px;height:20px;"><path d="M3 12l9-9 9 9M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/></svg>
    </div>
    <div class="task-items" id="task-list">
        <!-- Active windows injected here -->
    </div>
    <div id="clock-tray">
        <div id="time">12:00</div>
        <div id="date">2025/11/20</div>
    </div>
</div>

<script>
/* --- SVG Icons (Inline for portability) --- */
const icons = {
    pc: `<svg viewBox="0 0 24 24" fill="none" stroke="#4fc3f7" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>`,
    terminal: `<svg viewBox="0 0 24 24" fill="#333" stroke="#fff" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8l4 4-4 4M14 16h4"/></svg>`,
    notepad: `<svg viewBox="0 0 24 24" fill="#fff" stroke="#2196f3" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>`,
    paint: `<svg viewBox="0 0 24 24" fill="none" stroke="#e91e63" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>`,
    game: `<svg viewBox="0 0 24 24" fill="none" stroke="#ff9800" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h4M8 10v4M15 13h.01M18 11h.01"/></svg>`,
    code: `<svg viewBox="0 0 24 24" fill="none" stroke="#ab47bc" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
    folder: `<svg viewBox="0 0 24 24" fill="#ffd54f" stroke="#ff6f00" stroke-width="1"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>`,
    video: `<svg viewBox="0 0 24 24" fill="none" stroke="#f44336" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>`,
    browser: `<svg viewBox="0 0 24 24" fill="none" stroke="#00bcd4" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>`
};

/* --- System State --- */
let zIndexCounter = 100;
let windows = {};
let fileSystem = {
    "C": {
        "Users": {
            "Admin": {
                "Documents": { "readme.txt": "Welcome to WebOS!\nUse the terminal.", "todo.txt": "1. Build OS\n2. Sleep" },
                "Pictures": { "landscape.png": "[Image Data]", "cat.png": "[Image Data]" },
                "Desktop": {} 
            }
        },
        "Windows": {
            "System32": { "cmd.exe": "[Binary]", "kernel.dll": "[Binary]" }
        }
    }
};
let currentPath = ["C", "Users", "Admin"];

/* --- App Definitions --- */
const apps = [
    { id: 'explorer', name: 'ËµÑÊ∫êÁÆ°ÁêÜÂô®', icon: icons.folder, action: () => openWindow('explorer', 'Êñá‰ª∂ËµÑÊ∫êÁÆ°ÁêÜÂô®', renderExplorer()) },
    { id: 'terminal', name: 'ÁªàÁ´Ø', icon: icons.terminal, action: () => openWindow('terminal', 'ÁÆ°ÁêÜÂëò: Terminal', renderTerminal()) },
    { id: 'notepad', name: 'ËÆ∞‰∫ãÊú¨', icon: icons.notepad, action: () => openWindow('notepad', 'Êó†Ê†áÈ¢ò - ËÆ∞‰∫ãÊú¨', renderNotepad()) },
    { id: 'code', name: 'VS Code Lite', icon: icons.code, action: () => openWindow('code', 'Code Studio', renderCodeEditor()) },
    { id: 'paint', name: 'ÁîªÂõæ', icon: icons.paint, action: () => openWindow('paint', 'Êú™ÂëΩÂêç - ÁîªÂõæ', renderPaint()) },
    { id: 'game', name: 'Ë¥™ÂêÉËõá', icon: icons.game, action: () => openWindow('game', 'Game Box', renderGame()) },
    { id: 'video', name: 'ËßÜÈ¢ëÂâ™Ëæë', icon: icons.video, action: () => openWindow('video', 'Movie Maker', renderVideoApp()) },
    { id: 'browser', name: 'Edge', icon: icons.browser, action: () => openWindow('browser', 'Web Browser', '<div style="padding:20px; text-align:center; color:#888;"><h2>404 Not Found</h2><p>Simulation Mode: No real internet connection.</p></div>') },
];

/* --- Boot Sequence --- */
function startSystem() {
    const bootScreen = document.getElementById('boot-screen');
    const text = bootScreen.querySelector('.boot-text');
    
    // Audio Context for Boot Sound
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    
    // Play Startup Sound (Synth Chord)
    const playNote = (freq, time, dur) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(time);
        gain.gain.setValueAtTime(0.1, time);
        gain.gain.exponentialRampToValueAtTime(0.001, time + dur);
        osc.stop(time + dur);
    };
    
    // Simple C Major 7 chord ascending
    const now = audioCtx.currentTime;
    playNote(261.63, now, 1.5); // C4
    playNote(329.63, now + 0.1, 1.5); // E4
    playNote(392.00, now + 0.2, 1.5); // G4
    playNote(493.88, now + 0.3, 2.0); // B4

    text.innerText = "WELCOME";
    
    setTimeout(() => {
        bootScreen.style.opacity = 0;
        setTimeout(() => {
            bootScreen.style.display = 'none';
            initDesktop();
        }, 1000);
    }, 2000);
}

/* --- Initialization --- */
function initDesktop() {
    const desktop = document.getElementById('desktop');
    const startGrid = document.getElementById('start-apps');
    
    // Add icons to desktop
    apps.forEach(app => {
        // Desktop Icon
        if(app.id !== 'start') {
            const el = document.createElement('div');
            el.className = 'desktop-icon';
            el.innerHTML = `<div class="icon-img">${app.icon}</div><div>${app.name}</div>`;
            el.ondblclick = app.action;
            desktop.appendChild(el);
        }
        
        // Start Menu Item
        const startItem = document.createElement('div');
        startItem.className = 'start-item';
        startItem.innerHTML = `<div class="icon-img">${app.icon}</div><div>${app.name}</div>`;
        startItem.onclick = () => { toggleStartMenu(); app.action(); };
        startGrid.appendChild(startItem);
    });
    
    updateClock();
    setInterval(updateClock, 1000);
}

function updateClock() {
    const now = new Date();
    document.getElementById('time').innerText = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
    document.getElementById('date').innerText = now.getFullYear() + '/' + (now.getMonth()+1) + '/' + now.getDate();
}

function toggleStartMenu() {
    const menu = document.getElementById('start-menu');
    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
}

/* --- Window Manager --- */
function openWindow(appId, title, content) {
    const id = 'win-' + Date.now();
    const win = document.createElement('div');
    win.className = 'window';
    win.id = id;
    win.style.left = (100 + (Object.keys(windows).length * 30)) + 'px';
    win.style.top = (50 + (Object.keys(windows).length * 30)) + 'px';
    win.style.zIndex = ++zIndexCounter;
    win.style.width = '600px';
    win.style.height = '400px';
    
    // Find icon
    const appIcon = apps.find(a => a.id === appId)?.icon || '';

    win.innerHTML = `
        <div class="win-header" onmousedown="dragStart(event, '${id}')">
            <div class="win-title"><div style="width:16px;height:16px">${appIcon}</div> ${title}</div>
            <div class="win-controls">
                <div class="win-btn btn-min" onclick="minimizeWindow('${id}')"></div>
                <div class="win-btn btn-max" onclick="maximizeWindow('${id}')"></div>
                <div class="win-btn btn-close" onclick="closeWindow('${id}')"></div>
            </div>
        </div>
        <div class="win-body">${content}</div>
    `;
    
    win.onmousedown = () => {
        win.style.zIndex = ++zIndexCounter;
        updateTaskbar();
    };

    document.getElementById('desktop').appendChild(win);
    windows[id] = { title, icon: appIcon, minimized: false };
    
    updateTaskbar();

    // Post-render init for specific apps
    if(appId === 'paint') initPaint(win);
    if(appId === 'game') initGame(win);
    if(appId === 'terminal') initTerminal(win);
    if(appId === 'video') initVideo(win);
}

function closeWindow(id) {
    document.getElementById(id).remove();
    delete windows[id];
    updateTaskbar();
}

function minimizeWindow(id) {
    const win = document.getElementById(id);
    win.style.display = 'none';
    windows[id].minimized = true;
    updateTaskbar();
}

function maximizeWindow(id) {
    const win = document.getElementById(id);
    if (win.style.width === '100%') {
        win.style.width = '600px';
        win.style.height = '400px';
        win.style.top = '100px';
        win.style.left = '100px';
    } else {
        win.style.top = '0';
        win.style.left = '0';
        win.style.width = '100%';
        win.style.height = '100%';
    }
}

function restoreWindow(id) {
    const win = document.getElementById(id);
    win.style.display = 'flex';
    win.style.zIndex = ++zIndexCounter;
    windows[id].minimized = false;
    updateTaskbar();
}

function updateTaskbar() {
    const list = document.getElementById('task-list');
    list.innerHTML = '';
    Object.keys(windows).forEach(id => {
        const win = windows[id];
        const item = document.createElement('div');
        item.className = 'task-item' + (!win.minimized && document.getElementById(id).style.zIndex == zIndexCounter ? ' active' : '');
        item.innerHTML = win.icon;
        item.onclick = () => win.minimized ? restoreWindow(id) : minimizeWindow(id);
        list.appendChild(item);
    });
}

// Window Dragging Logic
let dragWin = null;
let diffX = 0, diffY = 0;

function dragStart(e, id) {
    if(e.target.classList.contains('win-btn')) return;
    dragWin = document.getElementById(id);
    diffX = e.clientX - dragWin.offsetLeft;
    diffY = e.clientY - dragWin.offsetTop;
    dragWin.style.zIndex = ++zIndexCounter;
}

document.addEventListener('mousemove', e => {
    if(dragWin) {
        dragWin.style.left = (e.clientX - diffX) + 'px';
        dragWin.style.top = (e.clientY - diffY) + 'px';
    }
});

document.addEventListener('mouseup', () => {
    dragWin = null;
});

/* --- Application Logic --- */

// 1. Explorer
function renderExplorer() {
    return `
    <div class="explorer-layout">
        <div class="sidebar">
            <div>üñ•Ô∏è Ê≠§ÁîµËÑë</div>
            <div style="margin-left:10px">üìÇ C:</div>
            <div style="margin-left:20px">üìÇ Users</div>
            <div style="margin-left:30px">üìÇ Admin</div>
        </div>
        <div class="main-files" id="file-view">
            ${renderFiles(currentPath)}
        </div>
    </div>`;
}

function getDir(path) {
    let dir = fileSystem;
    path.forEach(p => dir = dir[p]);
    return dir;
}

function renderFiles(pathArr) {
    const dir = getDir(pathArr);
    let html = '';
    // Back button if not root
    if (pathArr.length > 0) {
         html += `<div class="file-item" onclick="navigateUp()">
            <div class="file-icon" style="display:flex;justify-content:center;align-items:center;font-size:20px">‚¨ÜÔ∏è</div>
            <div class="file-name">...</div>
        </div>`;
    }
    
    Object.keys(dir).forEach(name => {
        const isFolder = typeof dir[name] === 'object';
        const icon = isFolder ? icons.folder : icons.notepad; // Simplified icons
        html += `<div class="file-item" onclick="${isFolder ? `navigateDown('${name}')` : `alert('Opening ${name}')`}">
            <div class="file-icon">${icon}</div>
            <div class="file-name">${name}</div>
        </div>`;
    });
    return html;
}

function navigateDown(folder) {
    currentPath.push(folder);
    // This is a hacky way to update active windows, in a real framework we'd bind state
    document.querySelectorAll('.main-files').forEach(el => el.innerHTML = renderFiles(currentPath));
}

function navigateUp() {
    currentPath.pop();
    document.querySelectorAll('.main-files').forEach(el => el.innerHTML = renderFiles(currentPath));
}

// 2. Terminal
function renderTerminal() {
    return `<div class="terminal" onclick="this.querySelector('.term-input').focus()">
        <div class="term-output">Microsoft Windows [ÁâàÊú¨ 10.0.22000.1]<br>(c) Microsoft Corporation„ÄÇ‰øùÁïôÊâÄÊúâÊùÉÂà©„ÄÇ<br><br></div>
        <div class="term-input-line">
            <span class="term-prompt" id="term-prompt">C:\\Users\\Admin></span>
            <input type="text" class="term-input" onkeydown="handleTermInput(event, this)">
        </div>
    </div>`;
}

let termMode = 'cmd';
function handleTermInput(e, input) {
    if (e.key === 'Enter') {
        const val = input.value.trim();
        const term = input.closest('.terminal');
        const output = term.querySelector('.term-output');
        const promptText = term.querySelector('#term-prompt').innerText;

        output.innerHTML += `${promptText} ${val}\n`;
        input.value = '';

        if (termMode === 'python') {
            if (val === 'exit()') {
                termMode = 'cmd';
                term.querySelector('#term-prompt').innerText = 'C:\\Users\\Admin>';
            } else {
                try {
                    const result = eval(val); // Dangerous in real web, safe in sandbox toy
                    if(result !== undefined) output.innerHTML += result + '\n';
                } catch(err) {
                    output.innerHTML += `Traceback (most recent call last):\n  File "<stdin>", line 1, in <module>\nNameError: ${err.message}\n`;
                }
            }
        } else {
            // CMD Mode
            if (val === 'python') {
                termMode = 'python';
                term.querySelector('#term-prompt').innerText = '>>>';
                output.innerHTML += `Python 3.9.5 (default, May 3 2021, 08:55:58)\n[Web Assembly] on win32\nType "help", "copyright", "credits" or "license" for more information.\n`;
            } else if (val === 'dir') {
                const dir = getDir(currentPath);
                output.innerHTML += Object.keys(dir).map(k => `<DIR> ${k}`).join('\n') + '\n';
            } else if (val === 'cls') {
                output.innerHTML = '';
            } else if (val === 'del system32') {
                 document.getElementById('bsod').style.display = 'block';
            } else if (val !== '') {
                output.innerHTML += `'${val}' ‰∏çÊòØÂÜÖÈÉ®ÊàñÂ§ñÈÉ®ÂëΩ‰ª§Ôºå‰πü‰∏çÊòØÂèØËøêË°åÁöÑÁ®ãÂ∫è„ÄÇ\n`;
            }
        }
        
        term.scrollTop = term.scrollHeight;
    }
}

function initTerminal(win) {
    win.querySelector('.term-input').focus();
}

// 3. Notepad
function renderNotepad() {
    return `<textarea class="notepad-area" spellcheck="false">ËøôÈáåÊòØËÆ∞‰∫ãÊú¨„ÄÇ\n‰Ω†ÂèØ‰ª•ËæìÂÖ•ÊñáÂ≠ó...</textarea>`;
}

// 4. Paint
function renderPaint() {
    return `
    <div style="height:100%; display:flex; flex-direction:column;">
        <div class="paint-toolbar">
            È¢úËâ≤: <input type="color" id="p-color" value="#000000">
            Á≤óÁªÜ: <input type="range" id="p-size" min="1" max="20" value="3">
            <button onclick="clearCanvas(this)">Ê∏ÖÁ©∫</button>
        </div>
        <div class="paint-canvas-container">
            <canvas width="500" height="300"></canvas>
        </div>
    </div>`;
}

function initPaint(win) {
    const canvas = win.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    const color = win.querySelector('#p-color');
    const size = win.querySelector('#p-size');
    let painting = false;

    // White bg
    ctx.fillStyle = 'white';
    ctx.fillRect(0,0,canvas.width, canvas.height);

    canvas.onmousedown = (e) => {
        painting = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
    };
    canvas.onmousemove = (e) => {
        if(painting) {
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.strokeStyle = color.value;
            ctx.lineWidth = size.value;
            ctx.lineCap = 'round';
            ctx.stroke();
        }
    };
    canvas.onmouseup = () => painting = false;
    canvas.onmouseleave = () => painting = false;
    
    win.clearCanvas = function(btn) {
        ctx.fillRect(0,0,canvas.width, canvas.height);
    }
}
function clearCanvas(btn) {
    btn.closest('.window').clearCanvas(btn);
}

// 5. Game (Snake)
function renderGame() {
    return `
    <div class="game-container">
        <div class="game-score">Score: 0</div>
        <canvas id="snake-canvas" width="400" height="300"></canvas>
        <div style="font-size:12px; color:#888; margin-top:5px">Use Arrow Keys to Move</div>
    </div>`;
}

function initGame(win) {
    const canvas = win.querySelector('#snake-canvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = win.querySelector('.game-score');
    
    const gridSize = 20;
    let snake = [{x: 10, y: 10}];
    let food = {x: 15, y: 10};
    let dx = 1, dy = 0;
    let score = 0;
    let gameLoop;

    function draw() {
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Move
        const head = {x: snake[0].x + dx, y: snake[0].y + dy};
        snake.unshift(head);
        
        // Eat
        if (head.x === food.x && head.y === food.y) {
            score += 10;
            scoreEl.innerText = 'Score: ' + score;
            food = {
                x: Math.floor(Math.random() * (canvas.width/gridSize)),
                y: Math.floor(Math.random() * (canvas.height/gridSize))
            };
        } else {
            snake.pop();
        }
        
        // Collision
        if (head.x < 0 || head.x >= canvas.width/gridSize || head.y < 0 || head.y >= canvas.height/gridSize) {
            clearInterval(gameLoop);
            alert('Game Over! Score: ' + score);
            return;
        }
        
        // Draw Snake
        ctx.fillStyle = '#0f0';
        snake.forEach(part => ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize-2, gridSize-2));
        
        // Draw Food
        ctx.fillStyle = 'red';
        ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize-2, gridSize-2);
    }

    document.addEventListener('keydown', e => {
        // Only control if this window is active/top
        if (win.style.zIndex != zIndexCounter) return;
        
        switch(e.key) {
            case 'ArrowUp': if(dy!==1) { dx=0; dy=-1; } break;
            case 'ArrowDown': if(dy!==-1) { dx=0; dy=1; } break;
            case 'ArrowLeft': if(dx!==1) { dx=-1; dy=0; } break;
            case 'ArrowRight': if(dx!==-1) { dx=1; dy=0; } break;
        }
    });

    gameLoop = setInterval(draw, 100);
    
    // Clean up on close
    const closeBtn = win.querySelector('.btn-close');
    const oldClose = closeBtn.onclick;
    closeBtn.onclick = () => { clearInterval(gameLoop); closeWindow(win.id); };
}

// 6. Code Editor
function renderCodeEditor() {
    return `<div class="code-layout">
        <div style="background:#252526; color:#fff; padding:5px; font-size:12px; border-bottom:1px solid #333">main.py - Code Studio</div>
        <div class="code-area">
            <div class="line-numbers">1<br>2<br>3<br>4<br>5</div>
            <textarea class="code-input">def hello():
    print("Hello World")
    return True

# Write your code here</textarea>
        </div>
        <div style="background:#007acc; color:white; padding:2px 10px; font-size:11px;">Python | Ln 1, Col 1</div>
    </div>`;
}

// 7. Video Editor (Timeline Mockup)
function renderVideoApp() {
    return `<div class="video-app">
        <div class="preview-area">
            <div id="preview-box" class="moving-box"></div>
        </div>
        <div style="padding:5px; background:#333; display:flex; justify-content:center;">
            <button class="play-btn" onclick="playVideoAnim(this)">‚ñ∂ Êí≠ÊîæÈ¢ÑËßà / Play</button>
        </div>
        <div class="timeline-area">
            <div class="track">
                <div class="clip" style="left: 0px; width: 100px;">Intro</div>
                <div class="clip" style="left: 110px; width: 200px; background:#d83b01;">Scene 1</div>
                <div class="clip" style="left: 320px; width: 150px; background:#107c10;">Scene 2</div>
            </div>
            <div class="track">
                <div class="clip" style="left: 0px; width: 470px; background:#5c2d91;">Audio Track</div>
            </div>
        </div>
    </div>`;
}

function initVideo(win) {
    // Enable dragging for clips (Mockup)
    // Simple horizontal drag logic could be added here
}

function playVideoAnim(btn) {
    const win = btn.closest('.window');
    const box = win.querySelector('#preview-box');
    box.animate([
        { transform: 'translateX(-100px) rotate(0deg)' },
        { transform: 'translateX(100px) rotate(180deg)' },
        { transform: 'translateX(-100px) rotate(360deg)' }
    ], {
        duration: 2000,
        iterations: 1
    });
}

</script>
</body>
</html>